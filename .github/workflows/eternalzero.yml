name: EternalZero Auto Renew

on:
  # 定时运行：每4小时执行一次
  schedule:
    - cron: '0 */4 * * *'  # 每4小时执行一次 (0点、4点、8点、12点、16点、20点 UTC)
  
  # 允许手动触发
  workflow_dispatch:

jobs:
  auto-renew:
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    # 授予工作流权限
    permissions:
        actions: write

    steps:
    - name: Checkout private script repository
      uses: actions/checkout@v4
      with:
        repository: kamanmuez/EternalZero-Auto-Renew  # 格式: username/repo-name
        token: ${{ secrets.PRIVATE_REPO_TOKEN }}  # 需要有读取私库权限的 PAT
        path: scripts
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      working-directory: scripts
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright browser
      working-directory: scripts
      run: |
        playwright install chromium
        playwright install-deps
        
    - name: Run renew script
      working-directory: scripts
      env:
        # 从 GitHub Secrets 读取 Cookie
        REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
        # 从 GitHub Secrets 读取服务器URL
        SERVER_URL: ${{ secrets.SERVER_URL }}
        # 设置无头模式
        HEADLESS: 'true'
        # Telegram 通知配置（可选）
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        # 设置时区为北京时间
        TZ: Asia/Shanghai
      run: |
        # 执行脚本（脚本会自动从环境变量读取 Cookie 和 Telegram 配置）
        python main.py
        
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_number }}
        path: scripts/*.png
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Clean up old workflow runs
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 86400  # 删除1天前的记录
